<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mini CD NFC</title>
</head>

<body>

  <p>Reproduciendo Mini CDâ€¦</p>

  <script>
(async function () {
  const params = new URLSearchParams(window.location.search);

  const cd = params.get("cd") || "SIN_CD";
  const plataforma = params.get("p") || "Desconocido";
  const tipo = params.get("t") || "";
  const id = params.get("id") || "";

  const ua = navigator.userAgent;
  let os = "Otro";
  if (/iPhone|iPad/i.test(ua)) os = "iOS";
  else if (/Android/i.test(ua)) os = "Android";

  const baseLogURL = "https://script.google.com/macros/s/TU_ID/exec";

  const query =
    "?cd=" + encodeURIComponent(cd) +
    "&p=" + encodeURIComponent(plataforma) +
    "&t=" + encodeURIComponent(tipo) +
    "&id=" + encodeURIComponent(id) +
    "&os=" + encodeURIComponent(os) +
    "&nav=" + encodeURIComponent(ua);

  try {
    // ðŸ”Ž CONSULTA ESTADO
    const r = await fetch(baseLogURL + "?cd=" + cd);
    const data = await r.json();

    if (!data.activo) {
      document.body.innerHTML =
        "<h2>Este Mini CD no estÃ¡ activo</h2>";
      return;
    }

    // ðŸ“¡ REGISTRO
    new Image().src = baseLogURL + query;

    // ðŸŽµ REDIRECCIÃ“N REAL A SPOTIFY
if (plataforma.toLowerCase() === "spotify" && id) {

  const spotifyApp = "spotify://track/" + id;
  const spotifyIntent =
    "intent://track/" + id +
    "#Intent;scheme=spotify;package=com.spotify.music;end";
  const spotifyWeb =
    "https://open.spotify.com/track/" + id;

  // 1ï¸âƒ£ Intento automÃ¡tico (Android)
  setTimeout(() => {
    window.location.href = spotifyIntent;
  }, 200);

  // 2ï¸âƒ£ Fallback a app directa
  setTimeout(() => {
    window.location.href = spotifyApp;
  }, 600);

  // 3ï¸âƒ£ Fallback web
  setTimeout(() => {
    window.location.href = spotifyWeb;
  }, 1200);

  // 4ï¸âƒ£ BotÃ³n manual (Brave / iOS)
  const btn = document.createElement("button");
  btn.innerText = "Abrir en Spotify";
  btn.style.fontSize = "18px";
  btn.style.padding = "14px 22px";
  btn.style.marginTop = "24px";

  btn.onclick = () => {
    window.location.href = spotifyApp;
  };

  document.body.appendChild(btn);
}

  } catch (e) {
    console.warn("Error de verificaciÃ³n", e);
  }
})();
</script>

</body>
</html>
