<script>
(function () {
  const params = new URLSearchParams(window.location.search);

  const cd = params.get("cd") || "SIN_CD";
  const plataforma = params.get("p") || "Desconocido";
  const tipo = params.get("t") || "";
  const id = params.get("id") || "";

  const ua = navigator.userAgent;

  let os = "Otro";
  if (/iPhone|iPad/i.test(ua)) os = "iOS";
  else if (/Android/i.test(ua)) os = "Android";

  // Construcción segura de URL
  const logURL =
    "https://script.google.com/macros/s/AKfycbx0AS46rpwfTbWNuA57WWRjOsGL40mrkHQn8tdGSvT4CeAQHN8uW-ToLZu5cg1WJDXI6A/exec" +
    "?cd=" + encodeURIComponent(cd) +
    "&p=" + encodeURIComponent(plataforma) +
    "&t=" + encodeURIComponent(tipo) +
    "&id=" + encodeURIComponent(id) +
    "&os=" + encodeURIComponent(os) +
    "&nav=" + encodeURIComponent(ua);

  // Registro universal (no bloqueante)
  const img = new Image();
  img.referrerPolicy = "no-referrer";
  img.src = logURL;

  // Redirección segura
  if (plataforma === "Spotify" && tipo === "track" && id) {
    setTimeout(function () {
      window.location.href =
        "https://open.spotify.com/track/" + id;
    }, 250);
  } else {
    document.body.innerHTML =
      "<p>Contenido no disponible</p>";
  }
})();
</script>
