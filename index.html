<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mini CD NFC</title>
</head>

<body>

  <p>Reproduciendo Mini CDâ€¦</p>

  <script>
(async function () {
  const params = new URLSearchParams(window.location.search);

  const cd = params.get("cd") || "SIN_CD";
  const plataforma = params.get("p") || "Desconocido";
  const tipo = params.get("t") || "";
  const id = params.get("id") || "";

  const ua = navigator.userAgent;
  let os = "Otro";
  if (/iPhone|iPad/i.test(ua)) os = "iOS";
  else if (/Android/i.test(ua)) os = "Android";

  const baseLogURL = "https://script.google.com/macros/s/AKfycbx0AS46rpwfTbWNuA57WWRjOsGL40mrkHQn8tdGSvT4CeAQHN8uW-ToLZu5cg1WJDXI6A/exec";

  const query =
    "?cd=" + encodeURIComponent(cd) +
    "&p=" + encodeURIComponent(plataforma) +
    "&t=" + encodeURIComponent(tipo) +
    "&id=" + encodeURIComponent(id) +
    "&os=" + encodeURIComponent(os) +
    "&nav=" + encodeURIComponent(ua);

  try {
    const res = await fetch(baseLogURL + query, { method: "GET" });
    const data = await res.json();

    if (data.activo === true) {
      if (plataforma === "Spotify" && tipo === "track" && id) {
        window.location.href =
          "https://open.spotify.com/track/" + id;
      }
    } else {
      window.location.href = "inactivo.html";
    }
  } catch (e) {
    // fallback seguro
    window.location.href = "inactivo.html";
  }
})();
</script>

</body>
</html>
