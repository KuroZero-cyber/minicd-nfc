<script>
(function () {
  const params = new URLSearchParams(window.location.search);

  const cd = params.get("cd") || "SIN_CD";
  const plataforma = params.get("p") || "";
  const tipo = params.get("t") || "";
  const id = params.get("id") || "";

  // ðŸ§  USER AGENT
  const ua = navigator.userAgent;

  // ðŸ“± SISTEMA OPERATIVO
  let sistema = "Otro";
  if (/Android/i.test(ua)) sistema = "Android";
  else if (/iPhone|iPad|iPod/i.test(ua)) sistema = "iOS";
  else if (/Windows NT/i.test(ua)) sistema = "Windows";
  else if (/Mac OS X/i.test(ua)) sistema = "macOS";
  else if (/Linux/i.test(ua)) sistema = "Linux";

  // ðŸŒ NAVEGADOR
  let navegador = "Otro";
  if (/Brave/i.test(ua)) navegador = "Brave";
  else if (/Edg/i.test(ua)) navegador = "Edge";
  else if (/OPR|Opera/i.test(ua)) navegador = "Opera";
  else if (/Firefox/i.test(ua)) navegador = "Firefox";
  else if (/Chrome/i.test(ua)) navegador = "Chrome";
  else if (/Safari/i.test(ua)) navegador = "Safari";

  const baseLogURL =
    "https://script.google.com/macros/s/AKfycbzE_3O1Ttm3hvwVz5QVlWuW6jLDSDsbBryaTzipojhsejVhxfXUygOkLuWRbGIyc9mgeA/exec";

  // ðŸŽµ APERTURA INMEDIATA
  if (plataforma === "Spotify" && tipo === "track" && id) {
    window.location.href = "spotify:track:" + id;
  }

  // ðŸ“¡ REGISTRO PASIVO (YA CON SISTEMA Y NAVEGADOR)
  const query =
    "?cd=" + encodeURIComponent(cd) +
    "&p=" + encodeURIComponent(plataforma) +
    "&t=" + encodeURIComponent(tipo) +
    "&id=" + encodeURIComponent(id) +
    "&os=" + encodeURIComponent(sistema) +
    "&nav=" + encodeURIComponent(navegador);

  new Image().src = baseLogURL + query;

  // ðŸ›Ÿ FALLBACK WEB
  if (plataforma === "Spotify" && tipo === "track" && id) {
    setTimeout(() => {
      window.location.href =
        "https://open.spotify.com/track/" + id;
    }, 1200);
  }

  // ðŸ–±ï¸ BOTÃ“N UNIVERSAL
  if (plataforma === "Spotify" && id) {
    const btn = document.createElement("button");
    btn.innerText = "Abrir en Spotify";
    btn.style.fontSize = "18px";
    btn.style.padding = "14px 22px";
    btn.style.marginTop = "24px";
    btn.style.cursor = "pointer";

    btn.onclick = () => {
      window.location.href =
        "https://open.spotify.com/track/" + id;
    };

    document.body.appendChild(btn);
  }
})();
</script>
