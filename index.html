<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mini CD NFC</title>
</head>

<body>

  <p>Reproduciendo Mini CDâ€¦</p>

  <script>
(async function () {
  const params = new URLSearchParams(window.location.search);

  const cd = params.get("cd") || "SIN_CD";
  const plataforma = params.get("p") || "Desconocido";
  const tipo = params.get("t") || "";
  const id = params.get("id") || "";

  const ua = navigator.userAgent;
  let os = "Otro";
  if (/iPhone|iPad/i.test(ua)) os = "iOS";
  else if (/Android/i.test(ua)) os = "Android";

  const baseLogURL = "https://script.google.com/macros/s/TU_ID/exec";

  const query =
    "?cd=" + encodeURIComponent(cd) +
    "&p=" + encodeURIComponent(plataforma) +
    "&t=" + encodeURIComponent(tipo) +
    "&id=" + encodeURIComponent(id) +
    "&os=" + encodeURIComponent(os) +
    "&nav=" + encodeURIComponent(ua);

  try {
    // ðŸ”Ž CONSULTA ESTADO
    const r = await fetch(baseLogURL + "?cd=" + cd);
    const data = await r.json();

    if (!data.activo) {
      document.body.innerHTML =
        "<h2>Este Mini CD no estÃ¡ activo</h2>";
      return;
    }

    // ðŸ“¡ REGISTRO
    new Image().src = baseLogURL + query;

    // ðŸŽµ REDIRECCIÃ“N (robusta + compatible)
if (plataforma.toLowerCase() === "spotify" && id) {

  // Intento automÃ¡tico
  setTimeout(() => {
    window.location.href =
      "https://open.spotify.com/track/" + id;
  }, 300);

  // Fallback manual (iOS / Brave)
  const btn = document.createElement("button");
  btn.innerText = "Abrir en Spotify";
  btn.style.fontSize = "18px";
  btn.style.padding = "12px 20px";
  btn.style.marginTop = "20px";

  btn.onclick = () => {
    window.location.href =
      "https://open.spotify.com/track/" + id;
  };

  document.body.appendChild(btn);
}

  } catch (e) {
    console.warn("Error de verificaciÃ³n", e);
  }
})();
</script>

</body>
</html>
